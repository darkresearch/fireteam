run-fireteam -c '
import asyncio
import base64
import json
import os
import sys
from pathlib import Path

# Add fireteam to path if needed
sys.path.insert(0, "/fireteam/src")

try:
    from fireteam import execute
    from fireteam.models import ExecutionMode
except ImportError:
    import fireteam
    from fireteam.api import execute
    from fireteam.models import ExecutionMode

async def main():
    # Decode instruction from base64
    instruction_b64 = os.environ.get("FIRETEAM_INSTRUCTION_B64", "")
    instruction = base64.b64decode(instruction_b64).decode()

    project_dir = Path("/app")

    print(f"Running fireteam on: {project_dir}")
    print(f"Instruction: {instruction[:200]}...")

    result = await execute(
        project_dir=project_dir,
        goal=instruction,
        context="",
        mode=None,  # Auto-detect complexity
        run_tests=True,
        max_iterations=5,
    )

    # Write result to log file
    result_data = {
        "success": result.success,
        "mode": result.mode.value if result.mode else None,
        "output": result.output,
        "error": result.error,
        "completion_percentage": result.completion_percentage,
    }

    with open("/logs/agent/fireteam-result.json", "w") as f:
        json.dump(result_data, f, indent=2)

    print(f"\nResult: {'"'"'success'"'"' if result.success else '"'"'failed'"'"'}")
    print(f"Completion: {result.completion_percentage}%")

    if result.error:
        print(f"Error: {result.error}")

    return result.success

if __name__ == "__main__":
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
' 2>&1 | tee /logs/agent/fireteam.txt
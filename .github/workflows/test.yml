name: Tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install dependencies
      run: uv sync --extra dev

    - name: Run ruff
      run: |
        source .venv/bin/activate
        ruff check src/ tests/

    - name: Run mypy
      run: |
        source .venv/bin/activate
        mypy src/

  fast-tests:
    name: Fast Tests (Unit + Lightweight)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install dependencies
      run: uv sync --extra dev

    - name: Run unit tests
      run: |
        source .venv/bin/activate
        pytest tests/ -v --tb=short

  e2e-tests:
    name: End-to-End Tests (API)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      github.ref == 'refs/heads/main' ||
      startsWith(github.ref, 'refs/heads/e/') ||
      startsWith(github.head_ref, 'e/')

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install dependencies
      run: uv sync --extra dev

    - name: Run integration tests
      timeout-minutes: 15
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        PYTHONUNBUFFERED: "1"
      run: |
        source .venv/bin/activate
        echo "Starting integration tests at $(date)"
        pytest tests/ --run-integration -v --tb=short -s
        echo "Integration tests completed at $(date)"

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-logs
        path: |
          /tmp/fireteam-test-*/
          tests/**/*.log
        retention-days: 7

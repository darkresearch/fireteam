#!/bin/bash
# Stop the Claude Agent System

set -e

SYSTEM_DIR="/home/claude/claude-agent-system"
PID_FILE="$SYSTEM_DIR/orchestrator.pid"

if [ ! -f "$PID_FILE" ]; then
    echo "Agent system is not running (no PID file found)"
    exit 0
fi

PID=$(cat "$PID_FILE")

if ! ps -p "$PID" > /dev/null 2>&1; then
    echo "Agent system is not running (stale PID file)"
    rm -f "$PID_FILE"
    exit 0
fi

echo "Stopping Claude Agent System (PID: $PID)..."

# Send SIGTERM for graceful shutdown
kill -TERM "$PID"

# Wait for process to exit (up to 30 seconds)
TIMEOUT=30
ELAPSED=0

while ps -p "$PID" > /dev/null 2>&1; do
    if [ $ELAPSED -ge $TIMEOUT ]; then
        echo "Process did not stop gracefully, forcing..."
        kill -KILL "$PID" 2>/dev/null || true
        break
    fi
    sleep 1
    ELAPSED=$((ELAPSED + 1))
done

# Kill any remaining Claude CLI processes
pkill -f "claude --dangerously-skip-permissions" 2>/dev/null || true

# Clean up PID file
rm -f "$PID_FILE"

echo "Agent system stopped"
